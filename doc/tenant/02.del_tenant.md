テナント減設
===

テナントの減設の手順を説明する。


## 目次

1. [パラメータの読み込み](#parameters)
1. 減設
    1. [停止](#stop)
    1. [減設作業](#add)
    1. [証明書の配置](#cert)
    1. [起動と確認](#up)
1. [テナント管理者の追加](./21.add_tenant_admin.md)


## <a name="parameters"></a> パラメータの読み込み

構築時に作成したパラメータファイル、もしくは、テナント増設時に読み込み済みのパラメータファイルを読み込む。

### 初期テナントを減設する場合

以下のコマンドで、パラメータを読み込む。
※Frontendサーバ、DBサーバの両方で行うこと。

```bash
root# source /root/cubee-dev/building/parameters.sh
```

### 増設したテナントを減設する場合

初期構築時に使用したパラメータ、今回用意したパラメータの順に読み込む。  
※`<>`箇所は書き換えること  
※Frontendサーバ、DBサーバの両方で行うこと。  
※対象のテナントを間違えないよう十分注意すること。

```bash
root# source /root/cubee-dev/building/parameters.sh
root# source /root/cubee-dev/building/parameters.<TENANT_NAME>.sh
```

## 減設

以下の手順で減設を行う。  
特に記載のない限り、Frontendサーバ上で実施する。


### <a name="stop"></a> 停止

[インストールガイド](../construct/31.updown.md)を参照。


### <a name="add"></a> 減設

#### 共用ファイルにおけるテナント用の記述を消す

権限管理DB接続情報ファイルを更新する。  
バックアップを取る。

```bash
root# echo ${TENANT_NAME}
```

削除しようとしているテナント名が出力されること。

```bash
root# mv /var/lib/docker/volumes/opt_cubee_cmnconf/_data/spf_rightctl_dbs.json /var/lib/docker/volumes/opt_cubee_cmnconf/_data/spf_rightctl_dbs.json.old.${NOWADAY}
```

記述を削除する。

```bash
root#  echo $TENANT_UUID
```

出力された 値を次のコマンドの `<TENANT_UUID>` に書き換えること。

```bash
root#  cat /var/lib/docker/volumes/opt_cubee_cmnconf/_data/spf_rightctl_dbs.json.old.${NOWADAY} | jq 'del(.["rightctl_<TENANT_UUID>"])'  > /var/lib/docker/volumes/opt_cubee_cmnconf/_data/spf_rightctl_dbs.json
```

docker-compsoe.yml の記述を更新する。  
バックアップを取る。

```bash
root# cp -p ${BUILD_DIR}/compose/docker-compose.yml ${BUILD_DIR}/compose/docker-compose.yml.old.${NOWADAY}
```

記述を削除する。

```bash
root# vi ${BUILD_DIR}/compose/docker-compose.yml
```

以下のセクションを削除する。  
`<TENANT_UUID>` は、前述のコマンドで確認したものを当てはめて確認すること。

```yaml
  spf-dckr-of-<TENANT_UUID>-01:
    command: /sbin/init
    container_name: spf-dckr-of-<TENANT_UUID>-01
    hostname: spf-dckr-of-<TENANT_UUID>-01
    image: spf-of
    networks:
    - cubee-network
    ports:
    - 4001:3004
    - 5001:9091
    privileged: true
    restart: always
    volumes:
    - /var/log/cubee/kvm_center//spf-dckr-of-<TENANT_UUID>-01:/opt/openfire/logs
    - /var/lib/docker/volumes/opt_openfire_conf/<TENANT_UUID>-01:/opt/openfire/conf
    - /var/lib/docker/volumes/opt_openfire_conf/<TENANT_UUID>-01/log4j.xml:/opt/openfire/lib/log4j.xml
    - opt_cubee_cert:/opt/cubee/cert
```


#### テナント用DBの減設

DB データを `psql` コマンドで直接操作することで、データを削除する。DBサーバ上で操作する。

以下の情報を、上述のパラメータファイルで確認しておくこと。

* TENANT_UUID
* POSTGRESQL_GLOBALSNS_ADMIN_PW
* POSTGRESQL_GLOBALSNS_PW
* POSTGRESQL_OPENFIRE_PW
* POSTGRES_PASSWORD


##### データベース、アカウントの削除

接続する。

各コマンド内で、`<TENANT_UUID>` と記載している個所は書き換えて実行すること。  
※パスワードは、`POSTGRESQL_GLOBALSNS_PW`

```shell
root# psql -U globalsns-${TENANT_UUID} globalsns
ユーザ globalsns-<TENANT_UUID> のパスワード: <パスワードを入力>
psql (9.6.7)
"help" でヘルプを表示します.

globalsns=>　
```

保有物を削除する。

```bash
globalsns=>  drop owned by "globalsns-<TENANT_UUID>";
```

※下記のようなWARNING が相当量出るが、これは問題の無い WARNING。

```
WARNING:  no privileges could be revoked for "user_account_store_id_seq"
-(略)-
WARNING:  no privileges could be revoked for "globalsns"
DROP OWNED
```

閲覧可能な globalsns_manager スキーマのテーブルのみが残ることを確認する。

```bash
globalsns=>  \dt;
                         リレーションの一覧
     スキーマ      |        名前        |    型    |     所有者
-------------------+--------------------+----------+-----------------
 globalsns_manager | cubee_system       | テーブル | globalsns_admin
 globalsns_manager | device_info_store  | テーブル | globalsns_admin
 globalsns_manager | shorten_uri_store  | テーブル | globalsns_admin
 globalsns_manager | system_conf        | テーブル | globalsns_admin
 globalsns_manager | tenant_store       | テーブル | globalsns_admin
 globalsns_manager | user_account_store | テーブル | globalsns_admin
 globalsns_manager | xmpp_server_store  | テーブル | globalsns_admin
(7 行)
```

切断する。

```bash
globalsns=>  \q
root# 
```

接続する。  
※パスワードは、`POSTGRESQL_GLOBALSNS_ADMIN_PW`

```shell
root# psql -U globalsns_admin globalsns
ユーザ postgres のパスワード: <パスワードを入力>
psql (9.6.7)
"help" でヘルプを表示します.

globalsns=>　\l
```

データベースなどを削除する。

```bash
globalsns=>  revoke all on database globalsns from "globalsns-<TENANT_UUID>";
globalsns=>  revoke all on schema globalsns_manager from "globalsns-<TENANT_UUID>";
globalsns=>  revoke all on table cubee_system, device_info_store, device_info_store_id_seq, shorten_uri_store, shorten_uri_store_id_seq, system_conf, tenant_store, user_account_store, user_account_store_id_seq from "globalsns-<TENANT_UUID>";
```

切断する。

```bash
postgres=>  \q
root# 
```

接続する。  
※パスワードは、`POSTGRES_PASSWORD`

```shell
root# psql -U postgres
ユーザ postgres のパスワード: <パスワードを入力>
psql (9.6.7)
"help" でヘルプを表示します.

postgres=>　\l
```

データベースなどを削除する。

```bash
postgres=>  drop role "globalsns-<TENANT_UUID>";
postgres=>  drop database "openfire-<TENANT_UUID>-01";
postgres=>  drop role "openfire-<TENANT_UUID>-01";
postgres=>  drop database "rightctl_<TENANT_UUID>";
```

切断する。

```bash
postgres=>  \q
root# 
```


##### 不要レコードの削除

接続する。  
※パスワードは、`POSTGRESQL_GLOBALSNS_ADMIN_PW`

```shell
root@act# psql -U globalsns_admin globalsns
ユーザ globalsns_admin のパスワード: <パスワードを入力>
psql (9.6.7)
"help" でヘルプを表示します.

globalsns=>　\l
```

レコードの削除。

```bash
globalsns=>  delete from tenant_store where uuid = '<TENANT_UUID>';
globalsns=>  delete from xmpp_server_store where tenant_uuid = '<TENANT_UUID>' ;
globalsns=>  delete from user_account_store where tenant_uuid = '<TENANT_UUID>' ;
```

切断する。

```bash
globalsns=>  \q
root# 
```

#### テナント用ファイルの削除

Frontendサーバ上で操作する。

##### データ・設定ファイルの削除

以下のコマンドを実行する。

```bash
root# echo ${TENANT_UUID}

root# cd /var/lib/docker/volumes/opt_cubee_license_tenant/_data
root# rm ${TENANT_UUID}.txt

root# cd /var/lib/docker/volumes/opt_cubee_node_data/_data
root# rm -rf ${TENANT_UUID}

root# cd /var/lib/docker/volumes/opt_openfire_conf
root# rm -rf ${TENANT_UUID}-01

```

##### ログファイルの削除

以下のコマンドを実行する。

```bash
root# cd ${LOG_DIR}
root# rm -rf ./spf-dckr-of-${TENANT_UUID}-01
```


### <a name="stop"></a> 起動と確認

[インストールガイド](../construct/31.updown.md)を参照。


### <a name="redis"></a> redis キャッシュのクリア

以下のコマンドを実行し、redis サーバの IPアドレスを確認する。

```bash
root# REDIS_IPADDRESS=`docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}'  spf-srvr-redis`
root# echo $REDIS_IPADDRESS
```

以下のコマンドを実行し、redis のキャッシュをクリアする。

```bash
root# redis-cli -h ${REDIS_IPADDRESS} -a ${REDIS_PASSWORD} flushall
OK
root# 
```


以上
