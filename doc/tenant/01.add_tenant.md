テナント増設
===

テナントの増設の手順を説明する。


## 目次

1. [パラメータの決定](#parameters)
1. 増設
    1. [停止](#stop)
    1. [増設作業](#add)
    1. [証明書の配置](#cert)
    1. [起動と確認](#up)
1. [テナント管理者の追加](./21.add_tenant_admin.md)


## <a name="parameters"></a> パラメータの決定

以下のパラメータを決定する必要がある。

| パラメータ名 | 指定例 | 説明 |
| -- | -- | -- |
| TENANT_NAME | spf | テナント名。<br>`0-9 a-z - _` の小文字のみ、256文字以内で指定。<br>利用者が入力するものであり、短く、理解しやすい文言を推奨する。 |
| TENANT_UUID | (略) | テナントを特定するキー。<br>`uuidgen -t` コマンドで生成したUUID。 |
| TENANT_LICENSE | (略) | テナントに使用する、契約により入手するライセンスキー（文字列） |
| TENANT_CONF | (略) | テナント設定。<br>[インストールガイド](../construct/12.parameters.md) を参照して検討すること。 |
| CUBEE_OPENFIRE_PW | (略) | 当該テナントにおけるシステム管理者アカウント（`admin`）のパスワード |
| OPENFIRE_WEB_PORT | 5002 | 5001 からの連番で、テナント毎に固有のポート番号。<br>Openfire管理コンソールのポートとして使用する。 |

下記のコマンドで、増設するテナント用のパラメータファイルを作成し、上記で決定したパラメータを記載する。  
※`<>`箇所は書き換えること  
※Frontendサーバ、DBサーバの両方で行うこと。

```bash
root# cat <<EOF> /root/rebecca-dev/building/parameters.<TENANT_NAME>.sh
## テナント名、UUID、ライセンスの定義
export TENANT_NAME=<TENANT_NAME>
export TENANT_UUID=<TENANT_UUID>
export TENANT_LICENSE=<TENANT_LICENSE>
export TENANT_CONF='<TENANT_CONF>'

## 当該テナントにおけるシステム管理者アカウント（admin）のパスワード
export CUBEE_OPENFIRE_PW='<CUBEE_OPENFIRE_PW>'

## テナントのOpenfire管理コンソールのポート
export OPENFIRE_WEB_PORT=<OPENFIRE_WEB_PORT>
EOF
```

作成したパラメータを読み込む。初期構築時に使用したパラメータ、今回用意したパラメータの順に読み込む。  
※`<>`箇所は書き換えること  
※Frontendサーバ、DBサーバの両方で行うこと。

```bash
root# source /root/rebecca-dev/building/parameters.sh
root# source /root/rebecca-dev/building/parameters.<TENANT_NAME>.sh
```

## 増設

以下の手順で構築を行う。  
特に記載のない限り、Frontendサーバ上で実施する。


### <a name="stop"></a> 停止

[インストールガイド](../construct/31.updown.md)を参照。  
※基本的に停止は不要。デモ環境などのお客様が使用されている可能性のある環境の場合はこの手順はスキップすること。


### <a name="add"></a> 構築

#### テナント用DBの構築

以下のコマンドを、DBサーバ上で実行する。

```bash
root# echo ${TENANT_NAME}
```

追加しようとしているテナント名が出力されること。

**※デモ環境にテナントを追加する場合は以下のコマンドにて、python2.7を使用するように変更を行うこと。  
これを行わないとエラーが発生し、正常にスクリプトを実行することができない。**

```bash
root# scl enable python27 bash
root# export PYTHONPATH="/usr/lib/python2.7/site-packages/":$PYTHONPATH
```

以下のコマンドにより新規テナントのDBテーブルが生成される。  

```bash
root# cd /root/rebecca-dev/building/
root# /bin/bash -xe construct_db_tenant.sh
```

※`ERROR:  role "rightctl" already exists` が出力されますが、問題ありません。

※デモ環境にて手順を実施している場合、以下の手順を行いAPNSのパスワードが  
**cubee4ever**に設定されていることを確認すること。**APNS_CERT_PASS=cubee4ever**となっていればOK。  
開発環境の場合はこの手順は不要。  

```bash
root# psql -U globalsns-${TENANT_UUID} globalsns
globalsns=> select * from tenant_system_conf;
```

正常に設定されていない場合、以下のコマンドを実行して値を更新する。  
```bash
globalsns=> update tenant_system_conf set value='cubee4ever' where conf_key='APNS_CERT_PASS';
```

#### テナント用設定ファイルの作成

以下のコマンドを実行する。Frontendサーバ上で実行する。

```bash
root# echo ${TENANT_NAME}
```

追加しようとしているテナント名が出力されること。   

**スクリプトの実行前に以下のコマンドを実行し、必要なコマンドラインツールが  
インストールされていることを確認すること。**

```bash
root# jq --version
jq-1.5
root# yq --version
yaml version 1.14.0-dev
```

インストールされていない場合、以下のコマンドよりインストールを行うこと。  
なお、yqのプログラムファイルを格納先は`/usr/local/bin/`としているが、  
`env | grep PATH`に記載のあるディレクトリに適宜書き換えること。

```bash
root# sudo yum install jq
root# jq --version
root# wget https://github.com/mikefarah/yq/releases/download/1.14.0/yq_linux_386
root# mv yq_linux_386 /usr/local/bin/yq
root# chmod 755 /usr/local/bin/yq
root# yq --version
```

以下のスクリプトの実行により、テナント用の設定ファイル群を作成する。  

```bash
root# cd /root/rebecca-dev/building/
root# /bin/bash -xe construct_configs_tenant.sh
```

### <a name="cert"></a> 証明書の配置

[インストールガイド](../construct/14.replace_cert.md) の「APNs アクセス用の証明書」章を参照。



### <a name="stop"></a> 起動と確認

[インストールガイド](../construct/31.updown.md)を参照。



## テナント管理者の追加

[別マニュアル](./21.add_tenant_admin.md)を参照。



以上
