$(function(){function e(){var e=0;"block"==$("#side-bar-murmur").css("display")&&(e=400);var t=280;$("body.sidebar-collapse").length>0&&(t=50),$(window).width()<768&&(t=0);var o=$(".content-wrapper .col_card").not(".content-wrapper .col_card.closeaa").length,n=$(".content-wrapper .col_card.chat_card.column-show-conversation-wrapper").not(".content-wrapper .col_card.closeaa").length,a=($(window).width()-t-e-30-10*o)/o,r=a,s=o*(r+10)+30;320>a&&(a=320),$(".content-wrapper .col_card").not(".content-wrapper .col_card.closeaa").css("width",a+"px");var i=(o-n)*(a-n+10)+610*n+30;e>0?$("#columnContainer").css("width",s+"px"):$("#columnContainer").css("width",""),$(".scroll_inner").css("width",i+"px"),wtc_scr.update(),head_scr.update()}function t(){$(".content-wrapper .col_card").each(function(){var e=0;$(this).find(".wrap-frm-message").siblings(".loading-readmore").length&&(e=$(this).find(".wrap-frm-message").siblings(".loading-readmore").outerHeight(!0));var t=$(this).outerHeight()-$(this).find(".column-header").outerHeight()-$(this).find(".wrap-frm-message").outerHeight()-e;$(this).find(".column-content").css("height",t+"px")}),col_scr.forEach(function(e){e.update()})}function o(){if($("div#profile_modal").length&&TabManager.getInstance().isActiveMyWorkplace()){var e=LoginUser.getInstance().getExtras().backgroundImage?LoginUser.getInstance().getExtras().backgroundImage:"dashboard_wrapper";$('div[name="mainWrapper"]').removeClass(function(e,t){return(t.match(/\bdashboard_w\S+/g)||[]).join(" ")}),$('div[name="mainWrapper"]').addClass(e)}$(".ui-dialog.on").animate({"margin-top":"-70px",opacity:0},200,function(){$(this).css("display","none"),$(".modal_card").css("display","none")}),$("#modal_area").off(),$("#modal_area").children().remove(),$("#modal_area").hide(),$(".overlay").animate({opacity:0},200,function(){$(this).remove()}),dlg_scr.forEach(function(e){e.destroy()}),dlg_scr=[]}function n(e){var t,o=ColumnManager.getInstance().getColumnList(),n=ColumnManager.getInstance().getColumnObjList(),a=o.get(f),r=n.get(f);a?t=a.getColumnType():i.closest("#side-bar-recent").length&&(t=ColumnInformation.TYPE_COLUMN_RECENT);var C=!1;if(t==ColumnInformation.TYPE_COLUMN_SHOW_CONVERSATION||t==ColumnInformation.TYPE_COLUMN_RECENT||t==ColumnInformation.TYPE_COLUMN_SEARCH||t==ColumnInformation.TYPE_COLUMN_FILTER||t==ColumnInformation.TYPE_COLUMN_CUSTOM_FILTER){if(null!=l)switch(l){case Message.TYPE_PUBLIC:t=ColumnInformation.TYPE_COLUMN_TIMELINE;break;case Message.TYPE_CHAT:t=ColumnInformation.TYPE_COLUMN_CHAT;break;case Message.TYPE_GROUP_CHAT:t=ColumnInformation.TYPE_COLUMN_GROUP_CHAT;break;case Message.TYPE_COMMUNITY:t=ColumnInformation.TYPE_COLUMN_COMMUNITY_FEED;break;case Message.TYPE_MURMUR:t=ColumnInformation.TYPE_COLUMN_MURMUR;break;default:t=a.getColumnType()}C=!0}switch(t){case ColumnInformation.TYPE_COLUMN_TIMELINE:var M=new PublicMessage;v(t,M,e,{ReplayItemId:s,ReplayBlock:i,WithAttatch:_,MessageBody:u,MessageTitle:p,WithNoteLink:m},r,a,function(e,t){CubeeServerConnector.getInstance().sendPublicMessage(e,t)});break;case ColumnInformation.TYPE_COLUMN_CHAT:var M=new ChatMessage;v(t,M,e,{isConversationOrRecent:C,ReplayItemId:s,ReplayBlock:i,RecentChatMsgTo:d,RecentChatMsgFrom:g,WithAttatch:_,MessageBody:u,MessageTitle:p,WithNoteLink:m},r,a,function(e,t){CubeeServerConnector.getInstance().sendChatMessage(e,t)});break;case ColumnInformation.TYPE_COLUMN_GROUP_CHAT:var M=new GroupChatMessage;v(t,M,e,{isConversationOrRecent:C,ReplayItemId:s,ReplayBlock:i,ConversationRoomId:c,WithAttatch:_,MessageBody:u,MessageTitle:p,WithNoteLink:m},r,a,function(e,t){CubeeServerConnector.getInstance().sendGroupChatMessage(e,t)});break;case ColumnInformation.TYPE_COLUMN_COMMUNITY_FEED:var M=new GroupChatMessage;v(t,M,e,{isConversationOrRecent:C,ReplayItemId:s,ReplayBlock:i,ConversationRoomId:c,WithAttatch:_,MessageBody:u,MessageTitle:p,WithNoteLink:m},r,a,function(e,t){CubeeServerConnector.getInstance().sendCommunityMessage(e,t)});break;case ColumnInformation.TYPE_COLUMN_MURMUR:var M=new MurmurMessage;v(t,M,e,{isConversationOrRecent:C,ReplayItemId:s,ReplayBlock:i,RecentChatMsgTo:d,WithAttatch:_,MessageBody:u,MessageTitle:p,WithNoteLink:m},r,a,function(e,t){CubeeServerConnector.getInstance().sendMurmurMessage(e,t)})}h=!1,$("emoji-picker").removeClass("open")}col_scr=[],$(".column-content.scroll_content").each(function(){$(this).closest("#side-bar-recent")||col_scr.push(new PerfectScrollbar($(this)[0],{suppressScrollX:!0}))});var a=[];$(".sidebar.scroll_content").each(function(){a.push(new PerfectScrollbar($(this)[0],{suppressScrollX:!0}))}),dlg_scr=[],$("#dialog_area .scroll_content").each(function(){dlg_scr.push(new PerfectScrollbar($(this)[0],{suppressScrollX:!0}))}),head_scr=new PerfectScrollbar("#mainHeader",{suppressScrollY:!0}),wtc_scr=new PerfectScrollbar("#watch_view .col_scroll_content",{suppressScrollY:!0}),pj_scr=new PerfectScrollbar("#project_scroll_area",{suppressScrollX:!0}),$(window).on("resize",function(){col_scr.forEach(function(e){e.update()}),a.forEach(function(e){e.update()}),dlg_scr.forEach(function(e){e.update()}),head_scr.update(),wtc_scr.update(),pj_scr.update()}),$("#mainHeader .ui-sortable .sortable-item").on("click",function(){var e=$(this).index(),t=$(".content-wrapper .col_card").eq(e).position().left,o=$(".content-wrapper .col_card").eq(e).outerWidth(),n=$("#watch_view .content_inner").position().left,a=$("#watch_view").outerWidth();-n>t-20?$("#watch_view .col_scroll_content").animate({scrollLeft:t-20}):t+o+20>-n+a&&$("#watch_view .col_scroll_content").animate({scrollLeft:t+o+20-a})}),$('[data-toggle="tooltip"]').tooltip({trigger:"hover"}),$(".user_menu_btn").on("click",function(){$(this).parents(".login_user").toggleClass("open")}),$(".sidebar-toggle").on("click",function(){return $("#left_sidebar .login_user").removeClass("open"),$("#left_sidebar").position().top>=1?($("#sidebar-collapse-goodjob-count").hide(),$("#sidebar-collapse-thanks-count").hide(),$("#sidebar-collapse-followee-count").hide(),$("#sidebar-collapse-follower-count").hide(),void $("#left_sidebar .login_user").removeClass("open")):void($(".sidebar-collapse").length?($("#sidebar-collapse-goodjob-count").hide(),$("#sidebar-collapse-thanks-count").hide(),$("#sidebar-collapse-followee-count").hide(),$("#sidebar-collapse-follower-count").hide(),$("#left_sidebar .login_user").removeClass("open")):($("#sidebar-collapse-goodjob-count").show(),$("#sidebar-collapse-thanks-count").show(),$("#sidebar-collapse-followee-count").show(),$("#sidebar-collapse-follower-count").show(),$("#left_sidebar .login_user").addClass("open")))}),$(document).on("click",".popup_btn",function(){$(".popup_list").not(this).stop().fadeOut(100),$(this).siblings(".popup_list").stop().fadeToggle(100)});var r=!1;$(document).on("click",".popup_btn, .column-header .col_menu .aleart_toggle",function(){r=!0}),$(document).on("click",function(){r?r=!1:$(".popup_list").stop().fadeOut(100)}),$(document).on("focus",".wrap-frm-message .message-input-area-title, .wrap-frm-message .message-input-area",function(){if(!$(this).closest(".wrap-frm-message").find(".message-attachment-area").is(":visible")){var e=$(this).closest(".wrap-frm-message").find(".message-attachment-area");e.slideToggle(200,function(){$(window).trigger("resize")})}}),$(document).on("click",function(e){if(!$(e.target).closest(".modal_card ").length&&!$(e.target).is("#quick-filter-read, #quick-filter-tome, #quick-filter-file"))for(var t=$(e.target).closest(".col_card"),o=$(document).find(".message-attachment-area"),n=0;n<o.length;n++){var a=$(o.get(n));t.length?!a.is(t.find(".message-attachment-area"))&&a.is(":visible")&&a.slideToggle(200,function(){$(window).trigger("resize")}):a.is(":visible")&&a.slideToggle(200,function(){$(window).trigger("resize")})}}),$(window).on("resize",e),t(),$(window).on("resize",function(){setTimeout(function(){t()},50)}),$("#header .sidebar-toggle").on("click",function(){setTimeout(function(){e(),$(window).trigger("resize")},300)}),$(document).on("click",".content-wrapper .col_card .col_close_btn",function(){var t=($(this),$(this).parents(".col_card").outerWidth());$(this).parents(".col_card").addClass("closeaa").css({"margin-right":-t+"px",opacity:0,"z-index":"1000"}),setTimeout(function(){wtc_scr.update(),head_scr.update()},300),e()}),$(document).on("click",".modal_exit",o),$(document).keyup(function(e){27===e.keyCode&&o()}),$(document).keydown(function(e){if(9===e.keyCode||9===e.which){if("none"==$("#login").css("display"))return!1;var t=document.activeElement.tabIndex;if(0>t||3==t)return $("[tabindex=1]").focus(),!1}}),$(".avatar_file_comm").click(function(){cropper_comm="",$(this).val(""),$(this).parents(".cropped_wrapper").find(".cropped").hide(),$(this).parents(".cropped_wrapper").find(".img_edit_area").hide()}),$(".avatar_file_comm").change(function(){this.files.length>0&&(reader_comm=new FileReader,reader_comm.onload=function(e){options_comm.imgSrc=e.target.result,cropper_comm=new cropbox(options_comm)},reader_comm.readAsDataURL(this.files[0]),$(this).parents(".cropped_wrapper").find(".cropped").hide(),$(this).parents(".cropped_wrapper").find(".img_edit_area").fadeIn())}),$("#settingproject_modal #btnCrop").on("click",function(){var e=cropper_comm.getDataURL();$(this).parents(".img_edit_area").nextAll(".cropped").replaceWith('<div class="cropped"><img src="'+e+'" class="mCS_img_loaded"></div>'),$(this).parents(".img_edit_area").hide(),$(this).parents(".img_edit_area").nextAll(".cropped").fadeIn()}),$("#settingproject_modal #btnZoomIn").on("click",function(){cropper_comm.zoomIn()}),$("#settingproject_modal #btnZoomOut").on("click",function(){cropper_comm.zoomOut()});var s,i,c,l,d,g,p,u,m,_,f=-1,h=!1;$(document).on("click",".emojibtn",function(e){if(h)h=!1;else if(!$(e.target).closest("emoji-picker").length&&$("emoji-picker").hasClass("open"))return void $("emoji-picker").removeClass("open");$("emoji-picker").addClass("open");var t=$(this).offset().top,o=$(this).offset().left;picker_width=$("emoji-picker").children().width();var n=t+30,a=o;a-=picker_width;var r=$("#columnContainer").offset().top,C=$("#columnContainer").offset().left;o-C<picker_width&&(a+=picker_width-(o-C));var v=$("#columnContainer").height()+r,M=$("emoji-picker").children().height();M>v-n&&(n-=M-(v-n)),$("emoji-picker").children().offset({top:n,left:a}),h=!0;for(var w=$("#columnInnerContainer").children(),T=-1,I=0;I<w.length;I++)$(w[I]).is($(e.currentTarget).closest(".col_card"))&&(T=I);f=T;var b=$(e.currentTarget).closest("div.message-border > div.read-message").attr("itemid");s=void 0,null!=b&&(s=b);var k=$(e.currentTarget).closest("div.message-border div.wrap-frm-message-reply");i=void 0,null!=k&&(i=k);var E=$(e.currentTarget).parent().parent().find("textarea.input-message-reply").attr("groupid");c=void 0,null!=E&&(c=E);var R=$(e.currentTarget).closest("div.message-border > div.read-message").attr("msgtype");if(l=void 0,null!=R)try{l=parseInt(R)}catch(y){}else null!=b&&(l=CubeeController.getInstance()._messageManager.getMessage(b).getType());var O=$(e.currentTarget).closest("div.message-border > div.read-message").attr("msgto");d=void 0,null!=O?d=O:l==Message.TYPE_CHAT&&(d=CubeeController.getInstance()._messageManager.getMessage(b).getTo());var L=$(e.currentTarget).closest("div.message-border > div.read-message").attr("msgfrom");g=void 0,null!=L?g=L:l==Message.TYPE_CHAT&&(g=CubeeController.getInstance()._messageManager.getMessage(b).getFrom());var P=$(e.currentTarget).parent().parent().find("textarea.message-input-area-title");p=void 0,P&&(p=P);var U=$(e.currentTarget).parent().parent().find("textarea.message-input-area,textarea.input-message-reply");u=void 0,U&&(u=U);var N=$(e.currentTarget).parent().parent().find(".attach-note-element p");m=void 0,N&&(m=N);var Y=$(e.currentTarget).parent().parent().find(".file-inputs p");_=void 0,Y&&(_=Y)}),$(document).on("click",function(e){h?h=!1:!$(e.target).closest("emoji-picker").length&&$("emoji-picker").hasClass("open")&&$("emoji-picker").removeClass("open")}),emojiPicker=window.emojiMart.definePicker("emoji-picker",{"native":!1,set:"twitter",title:"Emoji STAMP",onSelect:function(e){n(e)}});var C=function(e,t,o){if(null==e){console.log("error responce:"+JSON.stringify(e));var n=Resource.getMessage("dialog_title_stamp_error"),a=Resource.getMessage("dialog_error_send_stamp"),r=new DialogCloseView(n,a);r.showDialog()}else t&&e.content&&e.content.items&&1==e.content.items.length&&e.content.items[0].threadRootId&&CodiMdController.getInstance().assignNoteOnThreadRootId(e.content.items[0].threadRootId,t).then(function(e){})["catch"](function(e){var t=Resource.getMessage("dialog_title_system_info"),o=Resource.getMessage("dialog_error_assign_note_after_try"),n=new DialogCloseView(t,o);n.showDialog()})["finally"](function(){o.WithNoteLink.attr("value",""),o.WithNoteLink.attr("title",""),o.WithNoteLink.text(""),o.WithNoteLink.parent().find(".note_cancel_btn").remove()})},v=function(e,t,o,n,a,r,s){null==n.MessageBody||"string"!=typeof n.MessageBody.val()||n.MessageBody.val().match(/^\s*$/)?t.setMessage(o["native"]):t.setMessage(o["native"]+"< "+n.MessageBody.val()+" >"),t.setThreadTitle(n.MessageTitle.val()),e==ColumnInformation.TYPE_COLUMN_CHAT?n.isConversationOrRecent?n.RecentChatMsgTo!=LoginUser.getInstance().getJid()?t.setTo(n.RecentChatMsgTo):n.RecentChatMsgFrom!=LoginUser.getInstance().getJid()?t.setTo(n.RecentChatMsgFrom):console.log("not found chat to or from data."):t.setTo(r.getFilterCondition()):e==ColumnInformation.TYPE_COLUMN_GROUP_CHAT?n.isConversationOrRecent?t.setTo(n.ConversationRoomId):t.setTo(r.getChatRoomInfomation().getRoomId()):e==ColumnInformation.TYPE_COLUMN_COMMUNITY_FEED&&(n.isConversationOrRecent?t.setTo(n.ConversationRoomId):t.setTo(r.getCommunityInfomation().getRoomId())),t.setBodyType(Message.BODYTYPE_STAMP),null!=n.ReplayItemId&&n.ReplayItemId.length>0&&(t.setReplyItemId(n.ReplayItemId),n.ReplayBlock.css("display","none"));var i=n.WithNoteLink.attr("value"),c=n.WithAttatch.parent().parent().find('input[type="file"]').prop("files");c.length>0?M(c,a).then(function(o){t.addAttachedFileUrl(o.path),t.setMessage(t.getMessage()+"\n"+o.path),s(t,function(t,o){o&&e==ColumnInformation.TYPE_COLUMN_COMMUNITY_FEED?C(o,i,n):C(t,i,n)})})["catch"](function(e){var t=Resource.getMessage("dialog_title_system_info"),o=Resource.getMessage("dialog_update_file_error"),n=new DialogCloseView(t,o);n.showDialog()})["finally"](function(){n.WithAttatch.parent().parent().find('input[type="file"]').val(""),n.WithAttatch.attr("title",""),n.WithAttatch.text(""),n.WithAttatch.parent().parent().find("#fileupload_cancel_btn").remove()}):s(t,function(t,o){o&&e==ColumnInformation.TYPE_COLUMN_COMMUNITY_FEED?C(o,i,n):C(t,i,n)}),ViewUtils.setCharCounter(n.MessageBody.parent().find(".char-counter-title-column"),ColumnView.THREAD_TITLE_MAX_LENGTH),ViewUtils.setCharCounter(n.MessageBody.parent().find(".char-counter-column"),ColumnView.TEXTAREA_MAX_LENGTH),n.MessageBody.val(""),n.MessageTitle.val("")},M=function(e,t){return new Promise(function(o,n){var a=e&&e.length>0?e[0]:null;a&&CubeeController.getInstance().uploadFile(a,function(e){return"success"==e.result?void o(e):void n()},function(e){t._progressBar.setProgressValue(e)})})}});